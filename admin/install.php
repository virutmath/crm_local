<?session_start();error_reporting(E_ALL);require_once("../functions/functions.php");require_once("../classes/database.php");require_once("../classes/rain.tpl.class.php");require_once('resources/security/inc_constant.php');require_once("resources/security/functions.php");require_once("resources/security/functions_local.php");require_once("resources/security/functions_1.php");ob_clean();//các biến config$api_download_url = '';$api_get_url = '';$domain_server_url = '';$admin = '';$password = '';get_config_install($api_download_url, $api_get_url, $admin, $password, $domain_server_url);$db = new db_execute('TRUNCATE TABLE kdims',1,0);unset($db);$sql_kdims = 'INSERT INTO kdims(kdm_key,kdm_domain,kdm_hash) VALUES("rlWeMKxvBvV2L2MzBTIwZJH5AQHlBQR0LwL1ATAwZmV2ZQV1ZwExZvVfVaOup3ZvBvV0AmVjHGZ4AmEbAQpkZUN5ZQVmVa0=", "6cff8ec1e9452814b654cc32602524d2", "8c6fec8e6440423b4c32cca27e964f3c")';$db = new db_execute($sql_kdims,1,0);unset($db);//lấy ra danh sách các chi nhánh để tải thông tin tương ứng về$curl = curl_get_content($api_get_url, array('username' => $admin, 'password' => $password, 'action' => 'getListAgency'));$list_agencies = json_decode($curl, 1);$isAjaxRequest = !empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';if ($isAjaxRequest) {    $step = getValue('step', 'str', 'GET', '');    $agency_id = getValue('age_id', 'int', 'POST', 0);    switch ($step) {        case 'countAll' :            $curl = curl_get_content($api_download_url, array('action' => 'countAll', 'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data_count = json_decode($curl, 1);            echo json_encode($data_count);            break;        case 'commonConfig':            $array_return = array();            $curl = curl_get_content($api_download_url, array('action' => 'getCommonConfig', 'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl, 1);            //xử lý insert dữ liệu            synchronize_data_table($data);            $array_return = array('success' => 1, 'step' => 1);            echo json_encode($array_return);            break;        case 'menu':            $curl = curl_get_content($api_download_url, array('action' => 'getListMenu', 'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl, 1);            if (!isset($data['menu'])) {                http_response_code(404);                die();            }            $listMenu = $data['menu'];            $listMenuProduct = $data['menu_products'];            $db_field_menu = new db_query('SHOW FIELDS FROM menus');            $array_type_field = array();            while ($row = mysqli_fetch_assoc($db_field_menu->result)) {                $array_type_field[$row['Field']] = $row['Type'];            }            $record = getValue('record', 'int', 'POST', 0);            if (isset($listMenu[$record])) {                //insert menu vào bảng menus                $data_menu = $listMenu[$record];                $sql = 'INSERT INTO menus (';                $sql_value = ' VALUES (';                foreach ($data_menu as $k => $value) {                    if (isset($array_type_field[$k])) {                        $sql .= $k . ',';                        if (strpos($array_type_field[$k], 'int')) {                            $sql_value .= intval($value) . ',';                        } else {                            $sql_value .= '"' . $value . '",';                        }                    }                }                $sql = rtrim($sql, ',') . ')' . rtrim($sql_value, ',') . ')';                //insert vào database                $db_insert = new db_execute($sql,1,0);                //insert số lượng vào menu_products                $sql_product = 'INSERT INTO menu_products (mep_menu_id, mep_product_id, mep_quantity) VALUES';                foreach ($data_menu['menu_products'] as $value) {                    $sql_product .= '(' . $value['mep_menu_id'] . ',' . $value['mep_product_id'] . ', ' . $value['mep_quantity'] . '),';                }                $sql_product = rtrim($sql_product, ',');                $db_insert = new db_execute($sql_product,1,0);                unset($db_insert);                $picture_path = get_picture_path($data_menu['men_image']);                generate_dir_upload($data_menu['men_image'], 'organic');                @copy($domain_server_url . $data_menu['men_image_path'], '..' . $picture_path);                $array_return = array('success' => 1, 'data' => $data_menu, 'step' => $record + 1);                echo json_encode($array_return);            }            break;        case 'desk' :            $curl = curl_get_content($api_download_url, array('action' => 'getListDesk', 'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl, 1);            if (!isset($data['desk']) || !isset($data['section']) || !isset($data['service_desk'])) {                http_response_code(404);                die();            }            //insert dữ liệu            //insert bảng service_desks và sections ở lần request đầu tiên            $record = getValue('record', 'int', 'POST', 0);            if ($record === 0) {                //insert service_desk                $sql_service_desk = 'INSERT INTO service_desks(sed_id, sed_name, sed_agency_id, sed_phone, sed_note, sed_image) VALUES';                foreach ($data['service_desk'] as $svd) {                    $sql_service_desk .= '(' . $svd['sed_id'] . ',                                            "' . $svd['sed_name'] . '",                                            ' . $svd['sed_agency_id'] . ',                                            "' . $svd['sed_phone'] . '",                                            "' . $svd['sed_note'] . '",                                            "' . $svd['sed_image'] . '"),';                }                $sql_service_desk = rtrim($sql_service_desk, ',');                $db_insert = new db_execute($sql_service_desk,1,0);                unset($db_insert);                //insert section                $sql_section = 'INSERT INTO sections(sec_id,sec_name,sec_note,sec_service_desk) VALUES';                foreach ($data['section'] as $section) {                    $sql_section .= '(' . $section['sec_id'] . ',                                        "' . $section['sec_name'] . '",                                        "' . $section['sec_note'] . '",                                        ' . $section['sec_service_desk'] . '),';                }                $sql_section = rtrim($sql_section,',');                $db_insert = new db_execute($sql_section,1,0);                unset($db_insert);            }            //insert bàn            if (!isset($data['desk'][$record])) {                die();            }            $data_desk = $data['desk'][$record];            $sql_desk = 'INSERT INTO desks (des_id, des_name, des_sec_id, des_note)                         VALUES (' . $data_desk['des_id'] . ',"' . $data_desk['des_name'] . '",' . $data_desk['des_sec_id'] . ',"' . $data_desk['des_note'] . '")';            $db_insert = new db_execute($sql_desk,1,0);            unset($sql_desk);            $array_return = array('success' => 1, 'data' => $data_desk, 'step' => $record + 1);            echo json_encode($array_return);            break;        case 'current_desk':            $curl = curl_get_content($api_download_url,array('action'=>'getCurrentDesk','username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success'=>1,'step'=>1);            echo json_encode($array_return);            break;        case 'staff':            $curl = curl_get_content($api_download_url, array('action'=>'getStaffUser','username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success'=>1,'step'=>1);            echo json_encode($array_return);            break;        case 'product':            $record = getValue('record','int','POST',0);            //lấy từng product về            $curl = curl_get_content($api_download_url, array('action' => 'getProduct', 'record'=>$record ,'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            //insert vào product và product_quantity            synchronize_data_table($data);            //copy ảnh về            $image_src = $data['products']['image_path'];            @copy($domain_server_url . $image_src, generate_dir_upload($data['pro_image'],'organic'));            $array_return = array('success' => 1, 'step' => $record + 1);            echo json_encode($array_return);            break;        case 'promotion':            $curl = curl_get_content($api_download_url, array('action' => 'getPromotion' ,'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success' => 1, 'step' => 1);            echo json_encode($array_return);            break;        case 'supplier':            $curl = curl_get_content($api_download_url,array('action'=>'getSupplier','username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            //lấy ảnh về            foreach($data['suppliers'] as $k=>$supplier) {                if($supplier['image_path'] && $supplier['sup_image']) {                    @copy($domain_server_url . $supplier['image_path'],generate_dir_upload($supplier['sup_image'],'organic'));                }            }            $array_return = array('success' => 1, 'step' => 1);            echo json_encode($array_return);            break;        case 'customer':            $curl = curl_get_content($api_download_url,array('action'=>'getCustomer','username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success' => 1, 'step' => 1);            echo json_encode($array_return);            break;        case 'financial':            $record = getValue('record','int','POST',0);            $curl = curl_get_content($api_download_url,array('action'=>'getFinancial','record'=>$record,'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success' => 1, 'step' => $record+1);            echo json_encode($array_return);            break;        case 'bill_in':            $record = getValue('record','int','POST',0);            $curl = curl_get_content($api_download_url,array('action'=>'getBillIn','record'=>$record,'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success' => 1, 'step' => $record + 1);            echo json_encode($array_return);            break;        case 'bill_out':            $record = getValue('record','int','POST',0);            $curl = curl_get_content($api_download_url,array('action'=>'getBillOut','record'=>$record,'username' => $admin, 'password' => $password, 'agency' => $agency_id));            $data = json_decode($curl,1);            synchronize_data_table($data);            $array_return = array('success' => 1, 'step' => $record + 1);            echo json_encode($array_return);            break;    }//    $sleep_time = rand(0,500) * 1000;//    usleep($sleep_time);    die();}?><!DOCTYPE html><html><head>    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>    <title>CRM Restaurant</title>    <link rel="stylesheet" type="text/css" href="resources/css/font-awesome.min.css"/>    <link rel="stylesheet" type="text/css" href="resources/css/install.css"/>    <script src="resources/js/jquery.js" type="text/javascript"></script>    <script src="resources/js/jqueryui/ui/core.js"></script>    <script src="resources/js/jqueryui/ui/widget.js"></script>    <script src="resources/js/jqueryui/ui/mouse.js"></script>    <script src="resources/js/jqueryui/ui/position.js"></script>    <script src="resources/js/jqueryui/ui/draggable.js"></script>    <script src="resources/js/enscroll-0.5.5.min.js" type="text/javascript"></script>    <script src="resources/js/home.js" type="text/javascript"></script>    <script src="resources/js/crm.js" type="text/javascript"></script></head><body><div id="wrapper">    <h1>Cài đặt sử dụng</h1>    <label for="age_id">Chọn chi nhánh</label>    <select name="age_id" id="age_id">        <option value=""> -- chi nhánh --</option>        <? foreach ($list_agencies as $agency): ?>            <option value="<?= $agency['age_id'] ?>"><?= $agency['age_name'] ?></option>        <? endforeach; ?>    </select>    <button id="button" onclick="download()">Cài đặt</button>    <div class="clearfix"></div>    <div class="install-tips">        <div id="loading-message" class="hidden">            Đang tải <span id="module-in-progress"></span>            <span id="progress">                <span id="step">0</span>/<span id="total">0</span>            </span>        </div>        <div id="success-message" class="hidden">Hoàn thành</div>        <div id="loading-progress-bar">            <span id="loading-progress-bar-step"></span>        </div>    </div>    <div class="clearfix"></div>    <div id="after-setting" class="hidden">        <a href="login.php">Đăng nhập vào hệ thống</a>    </div></div><script src="resources/js/install.js" type="text/javascript"></script></body></html>